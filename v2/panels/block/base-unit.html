<script>
	const design = fanstatic.design;
	const controller = {};

	return {
		onload: async function (roof, data = {}, url) {
			const scope = data.scope || fanstatic.resolvePanelScope(url);
			const mode = data.mode || 0;

			if (3 == mode) { // head, body, foot
				if (!data.footnotes) data.footnotes = [];
				data.figure = false;
			}
			else if (4 == mode) { // cap, head, body
				if (!data.figure) data.figure = [];
				data.footnotes = false;
			}
			else if (1 == mode) { // all
				if (!data.footnotes) data.footnotes = [];
				if (!data.figure) data.figure = [];
			}
			else if (2 == mode) { // head and body only
				data.figure = false;
				data.footnotes = false;
			}

			roof.innerHTML = fanstatic.renderJhtm([
				design.unit({
					mode: mode,
					cap: data.figure ? design.element('figure', data.figure) : false,
					head: data.titles ? design.axis(data.titles.map(jhtm => design.element('div', jhtm))) : false,
					body: data.contents ? design.axis(data.contents.map(jhtm => design.element('div', jhtm))) : false,
					foot: data.footnotes ? design.axis(data.footnotes.map(jhtm => design.element('div', jhtm))) : false,
				}, {data: { ds: { scope: scope }}})
			]);

			const panelElement = roof.children[0];
			const cap = panelElement.querySelector(':scope > [data-ds="unit-cap"]')
			const head = panelElement.querySelector(':scope > [data-ds="unit-head"]')
			const body = panelElement.querySelector(':scope > [data-ds="unit-body"]')
			const foot = panelElement.querySelector(':scope > [data-ds="unit-foot"]')

			if (cap) cap.dataset['dsRole'] = 'figure';
			if (head) head.dataset['dsRole'] = 'title';
			if (body) body.dataset['dsRole'] = 'content';
			if (foot) foot.dataset['dsRole'] = 'footnote';
			
			for (let el of panelElement.children) { el.dataset['dsScope'] = scope; }
			
			controller.panelElement = panelElement;
		},
		controller: controller
	};
</script>
