<script>
	const design = fanstatic.design;

	return async function (roof, data = {}, url) {
		const panelScope = data.panelScope || fanstatic.resolvePanelScope(url);
		const outerScope = data.scope;
		const innerScope = data.innerScope || outerScope || data.id || panelScope;
		// const mode = data.mode || 0;

		// if (1 == mode) { // all
		// 	if (!data.actions) data.actions = [];
		// 	if (!data.image) data.image = [];
		// }
		// else if (2 == mode) { // head and body only
		// 	data.image = false;
		// 	data.actions = false;
		// }
		// else if (3 == mode) { // head, body, foot
		// 	if (!data.actions) data.actions = [];
		// 	data.image = false;
		// }
		// else if (4 == mode) { // cap, head, body
		// 	if (!data.image) data.image = [];
		// 	data.actions = false;
		// }

		if (data.subjects && !Array.isArray(data.subjects)) data.subjects = [data.subjects];
		if (data.actions && !Array.isArray(data.actions)) data.actions = [data.actions];

		const unitController = await fanstatic.insertPanel(roof, 'block.unit', {
				id: data.id,
				panelScope: panelScope,
				scope: data.scope,
				innerScope: data.innerScope,
				mode: data.mode,
				cap: data.image ? design.element('img', {src: data.image}) : false,
				head: data.subjects ? data.subjects.map(() => design.div()) : false,
				body: data.message ? data.message : false,
				foot: data.actions ? data.actions.map(() => design.div()) : false,

				$tag: data.$tag,
				$attr: data.$attr,
				$capTag: data.$imageTag,
				$headTag: data.$subjectsTag,
				$bodyTag: data.$messageTag,
				$footTag: data.$actionsTag,
			}
		);

		const panelElement = roof.children[0];

		if (data.image) unitController.capElement.dataset.pn = 'image';
		if (data.subjects) {
			unitController.headElement.dataset.pn = 'subjects';
			const divs = Array.from(unitController.headElement.children);

			for (let i=0; i<data.subjects.length; i++) {
				await fanstatic.applyContent(divs[i], data.subjects[i], innerScope);
			}
		}
		if (data.message) unitController.bodyElement.dataset.pn = 'message';
		if (data.actions) {
			unitController.footElement.dataset.pn = 'actions';
			const divs = Array.from(unitController.footElement.children);

			for (let i=0; i<data.subjects.length; i++) {
				await fanstatic.applyContent(divs[i], data.actions[i], innerScope);
			}
		}

		if (data.id) panelElement.id = data.id;
		if (outerScope) panelElement.dataset.pnScope = outerScope;
		panelElement.dataset.pnPanel = panelScope;

		this.controller = {
			panelElement: panelElement,
			scope: outerScope,
			panelScope: panelScope,
		};
	};
</script>
