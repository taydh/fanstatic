<script>
	const design = fanstatic.design;

	return async function (roof, data = {}, url) {
		const panelScope = data.panelScope || fanstatic.resolvePanelScope(url);
		const scope = data.scope || panelScope;

		roof.innerHTML = fanstatic.renderJhtm([
			design.unit({data: { pn:  { scope: scope, panel: panelScope }}}, {
				mode: data.mode,
				cap: !!data.cap,
				head: !!data.head,
				body: !!data.body,
				foot: !!data.foot,
			})
		]);

		const panelElement = roof.children[0];

		if (data.id) panelElement.id = data.id;

		panelElement.dataset.pnScope = scope;
		panelElement.dataset.pnPanel = panelScope;

		let capProm, headProm, bodyProm, footProm;
		
		if (data.cap) {
			const target = panelElement.querySelector('[data-ds=cap]')
			target.dataset.pn = 'cap';
			capProm = fanstatic.applyContent(target, data.cap);
		}
		
		if (data.head) {
			const target = panelElement.querySelector('[data-ds=head]');
			target.dataset.pn = 'head';
			headProm = fanstatic.applyContent(target, data.head);
		}

		if (data.body) {
			const target = panelElement.querySelector('[data-ds=body]');
			target.dataset.pn = 'body';
			bodyProm = fanstatic.applyContent(target, data.body);
		}

		if (data.foot) {
			const target = panelElement.querySelector('[data-ds=foot]')
			target.dataset.pn = 'foot';
			footProm = fanstatic.applyContent(target, data.foot);
		}

		panelElement.querySelectorAll(':scope > [data-ds]').forEach(elem => elem.removeAttribute('data-ds'));
		panelElement.removeAttribute('data-ds');

		const resolves = await Promise.all([capProm, headProm, bodyProm, footProm]);

		this.controller = {
			panelElement: panelElement,
			capController: resolves[0],
			headController: resolves[1],
			bodyController: resolves[2],
			footController: resolves[3],
		};
	};
</script>
