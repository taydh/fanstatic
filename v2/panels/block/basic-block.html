<script>
	const design = fanstatic.design;
	const controller = {};

	return async function (roof, data = {}, url) {
		const panelScope = fanstatic.resolvePanelScope(url);
		const scope = data.scope || panelScope;
		const mode = data.mode || 0;

		if (1 == mode) { // all
			if (!data.notes) data.notes = [];
			if (!data.image) data.image = [];
		}
		else if (2 == mode) { // head and body only
			data.image = false;
			data.notes = false;
		}
		else if (3 == mode) { // head, body, foot
			if (!data.notes) data.notes = [];
			data.image = false;
		}
		else if (4 == mode) { // cap, head, body
			if (!data.image) data.image = [];
			data.notes = false;
		}

		if (data.subjects && !Array.isArray(data.subjects)) data.subjects = [data.subjects];
		if (data.notes && !Array.isArray(data.notes)) data.notes = [data.notes];

		const basicUnitController = await fanstatic.insertPanel(roof, 'block.base-unit', {
				scope: scope,
				mode: mode,
				cap: data.image ? design.element('img', {src: data.image}) : false,
				head: data.subjects ? data.subjects.map(jhtm => design.div([jhtm])) : false,
				body: data.message ? data.message : false,
				foot: data.notes ? data.notes.map(jhtm => design.div([jhtm])) : false,
			}
		);

		const panelElement = roof.children[0];
		
		if (data.image) panelElement.querySelector(':scope > [data-ds=cap]').dataset.pnRole = 'image';
		if (data.subjects) panelElement.querySelector(':scope > [data-ds=head]').dataset.pnRole = 'subjects';
		if (data.message) panelElement.querySelector(':scope > [data-ds=body]').dataset.pnRole = 'message';
		if (data.notes) panelElement.querySelector(':scope > [data-ds=foot]').dataset.pnRole = 'notes';

		panelElement.dataset.pnPanel = panelScope;
		panelElement.querySelectorAll(':scope > [data-ds]').forEach(elem => elem.removeAttribute('data-ds'));
		panelElement.removeAttribute('data-ds');

		controller.panelElement = panelElement;
		controller.basicUnitController = basicUnitController;

		this.controller = controller;
	};
</script>
