<script>
	const design = fanstatic.design;

	return async function (roof, data = {}, url) {
		const panelScope = data.panelScope || fanstatic.resolvePanelScope(url);
		const outerScope = data.scope;
		const innerScope = data.innerScope || outerScope || data.id || panelScope;
		const itemControllers = [];

		roof.innerHTML = fanstatic.renderJhtm(design.grid(
			{'data-pn': 'grid'},
			{},
			data.items ? data.items.map(item => design.placeholder()) : []
		));

		const panelElement = roof.children[0];

		if (data.id) panelElement.id = data.id;
		if (outerScope) panelElement.dataset.pnScope = outerScope;
		panelElement.dataset.pnPanel = panelScope;

		const itemNodes = panelElement.querySelectorAll('[data-ds=grid_item]');
		const placeholderNodes = panelElement.querySelectorAll('[data-ds-placeholder]');
		
		panelElement.removeAttribute('data-ds');

		for (const i in data.items) {
			itemNodes[i].dataset.pn = 'grid_item';
			itemNodes[i].removeAttribute('data-ds');

			const template = data.items[i];
			
			if (innerScope) template.outerScope(innerScope);

			itemControllers.push(await fanstatic.applyTemplate(placeholderNodes[i], template, 'replace'));
		}

		this.controller = {
			panelElement: panelElement,
			itemControllers: itemControllers,
			scope: outerScope,
			panelScope: panelScope,
		};
	};
</script>
